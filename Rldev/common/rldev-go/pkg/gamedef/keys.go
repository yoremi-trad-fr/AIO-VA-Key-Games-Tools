package gamedef

import "fmt"

// Known XOR encryption keys for specific games.
// From lz_comp_rl.cpp and game definition files.
//
// These are applied to decompressed bytecode data to decrypt per-game encryption.
// Each game can have multiple subkeys applied at different offsets.

// Predefined game keys
var (
	// KeyCFV is the Clannad Full Voice encryption key.
	KeyCFV = []XORSubkey{
		{Offset: 256, Length: 257, Data: [16]byte{
			0xaf, 0x2f, 0xfb, 0x6b, 0xaf, 0x30, 0x77, 0x17,
			0x87, 0x48, 0xfe, 0x2c, 0x68, 0x1a, 0xb9, 0xf0}},
	}

	// KeyLB is the Little Busters! encryption key.
	KeyLB = []XORSubkey{
		{Offset: 256, Length: 257, Data: [16]byte{
			0xa8, 0x28, 0xfd, 0x66, 0xa0, 0x23, 0x77, 0x69,
			0xf9, 0x45, 0xf8, 0x2c, 0x7c, 0x00, 0xad, 0xf4}},
	}

	// KeyLBEX is the Little Busters! EX / Memorial Edition encryption key.
	KeyLBEX = []XORSubkey{
		{Offset: 256, Length: 128, Data: [16]byte{
			0xa8, 0x28, 0xfd, 0x71, 0xb4, 0x23, 0x64, 0x15,
			0x96, 0x48, 0x8a, 0x43, 0x62, 0x0e, 0xad, 0xf0}},
		{Offset: 384, Length: 128, Data: [16]byte{
			0xde, 0xd9, 0x4a, 0x18, 0xaf, 0x23, 0x1d, 0x9a,
			0xac, 0x23, 0x25, 0x48, 0xd8, 0xd4, 0x8f, 0xa7}},
		{Offset: 512, Length: 16, Data: [16]byte{
			0xde, 0xf1, 0xb7, 0x69, 0x1b, 0x00, 0x79, 0x8f,
			0x3a, 0x6b, 0xaf, 0x0b, 0xba, 0xda, 0x22, 0x57}},
		{Offset: 528, Length: 113, Data: [16]byte{
			0x76, 0xf1, 0xb7, 0x69, 0x1b, 0x00, 0x79, 0x8f,
			0x3a, 0x6b, 0xaf, 0x0b, 0xba, 0xda, 0x22, 0x57}},
	}

	// KeyFIVE is the 5 -Faibu- (by RAM) encryption key.
	KeyFIVE = []XORSubkey{
		{Offset: 256, Length: 128, Data: [16]byte{
			0xe5, 0xe8, 0x20, 0xe8, 0x6e, 0x91, 0xb4, 0xb1,
			0x4b, 0xc5, 0x34, 0x9e, 0xad, 0x2c, 0x71, 0x32}},
		{Offset: 384, Length: 128, Data: [16]byte{
			0x4a, 0x05, 0xad, 0x8b, 0xa4, 0xa9, 0x89, 0x8d,
			0xd4, 0xe9, 0x87, 0xf8, 0xee, 0x2e, 0x99, 0x65}},
		{Offset: 512, Length: 16, Data: [16]byte{
			0x4a, 0xed, 0x8d, 0x63, 0xca, 0x38, 0x3d, 0x3c,
			0x9f, 0x2c, 0xb3, 0x66, 0x43, 0x02, 0xe8, 0x57}},
		{Offset: 528, Length: 113, Data: [16]byte{
			0xaf, 0xed, 0x8d, 0x63, 0xca, 0x38, 0x3d, 0x3c,
			0x9f, 0x2c, 0xb3, 0x66, 0x43, 0x02, 0xe8, 0x57}},
	}

	// KeySNOW is the Snow Standard Edition encryption key.
	KeySNOW = []XORSubkey{
		{Offset: 256, Length: 257, Data: [16]byte{
			0xe4, 0xab, 0xa2, 0xc9, 0xec, 0x39, 0x36, 0x62,
			0xc9, 0x03, 0xba, 0x6d, 0x2e, 0x9c, 0xf2, 0x64}},
	}
)

// KnownGames maps game identifiers to their predefined keys.
var KnownGames = map[string][]XORSubkey{
	"CFV":  KeyCFV,
	"LB":   KeyLB,
	"LBEX": KeyLBEX,
	"LBME": KeyLBEX, // Memorial Edition uses same keys as EX
	"FIVE": KeyFIVE,
	"SNOW": KeySNOW,
}

// SetKeyFromHex parses a 32-character hex string into a 16-byte XOR key.
// Returns a single subkey with the standard offset (256) and length (257).
func SetKeyFromHex(hexStr string) (XORSubkey, error) {
	if len(hexStr) != 32 {
		return XORSubkey{}, fmt.Errorf("key must be 32 hex characters, got %d", len(hexStr))
	}
	var key [16]byte
	for i := 0; i < 16; i++ {
		var b byte
		_, err := fmt.Sscanf(hexStr[i*2:i*2+2], "%02x", &b)
		if err != nil {
			return XORSubkey{}, fmt.Errorf("invalid hex at position %d: %w", i*2, err)
		}
		key[i] = b
	}
	return XORSubkey{Offset: 256, Length: 257, Data: key}, nil
}
